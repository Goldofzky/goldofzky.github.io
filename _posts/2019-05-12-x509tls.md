---
layout: post
title:  "探索TLS中的数字证书"
subtitle: "从x509标准来验证HTTPS的可靠性"
header-img: "img/about-bg-walle.jpg"
tag: 
    - 网络原理
---

# TLS握手过程
![](/img/in-post/TLS/handshake.jpg)

# x509标准
>X.509是一种非常通用的证书格式。所有的证书都符合ITU-T X.509国际标准，因此(理论上)为一种应用创建的证书可以用于任何其他符合X.509标准的应用。

* 证书
  * 版本号
  * 序列号
  * 签名算法
  * 颁发者
  * 证书有效期
    * 此日期前无效
    * 此日期后无效
  * 主题
  * 主题公钥信息
    * 公钥算法
    * 主题公钥
  * 颁发者唯一身份信息（可选项）
  * 主题唯一身份信息（可选项）
  * 扩展信息（可选项）
    * ...
* 证书签名算法
* 数字签名

# 生成一个数字证书
## 生成Root证书
以百度的证书链为例：  
![](/img/in-post/TLS/root-crt.png)
第一层就是Root证书，它就是`自签名`的证书。即颁发者为自己。通常为一级CA认证机构的证书。 
![](/img/in-post/TLS/root-crt2.png)
1. **生成私钥:**私钥作为非对称加密的重要部分，通常存在服务端，十分重要，不能泄漏。
2. **生成CA的证书:**输入证书的相关信息，用hash函数生成信息的摘要，用第一步生成的私钥对这个摘要进行加密，生成"数字签名"，便于之后的验证。
![](/img/in-post/TLS/signing.png)

## 用生成的Root的证书签署下级证书
1. **生成私钥**
2. **生成CSR文件:**CSR是证书请求文件，它用于申请证书。我们通常将CSR文件送给CA认证机构，然后让他们帮我们生成证书。CA机构通常都是权威的，通用的浏览器以及其他终端都会在客户端中加入这些CA证书的信任，因此我们可以判断一次访问是安全的，因为CA机构值得信任，他们对自己私钥的保密程度极其的高。生成CSR文件时，我们需要提供自己的基本信息以及第一步生成的私钥加密。其中包含了我们的公钥和基本信息。
3. **用CSR文件生成CRT文件:**在这里，CA机构会用自己的私钥对CSR中用hash函数生成的摘要进行加密，生成一个加密的数字摘要(`数字签名`)。最后生成的证书包含签名后的证书以及CA机构的公钥。

## 证书认证
### 身份验证
* 验证域名等信息是否与访问页所匹配
>eg. 颁发给百度的数字证书当然不能给谷歌使用

### 匹配CRL
* CRL即证书吊销列表，若私钥泄漏，可向CA机构请求吊销，减少损失。若发现该证书在吊销列表中，则提醒证书已被吊销，不安全。
![](/img/in-post/TLS/crl.png)

### 数字签名认证
* 用hash函数生成证书的摘要，并用公钥解开证书的数字签名，将二者相比较，若相等，则验证成功。

### 验证证书链
>证书颁发机构不直接从其根源发布服务器证书（最终用户SSL证书）。这是很危险的，因为如果出现任何错误发布或要求撤销每个使用root签名的证书，那么将立即不受信任。因此，为了自我隔离，CA通常会发出所谓的中间根。CA用它的私有密钥对中间根进行签名，这使得它可信。然后CA使用中间证书的私钥来签署最终用户SSL证书。这个过程可以执行多次，其中中间根对另一个中间根进行签名，然后CA使用它来对证书进行签名。

![](/img/in-post/TLS/link.png)
证书可以抽象成三个级别
* **end-user**：即 baidu.com，该证书包含百度的公钥，访问者就是使用该公钥将数据加密后再传输给百度，即在 HTTPS 中使用的证书
* **intermediates**：即上文提到的 签发人 Issuer，用来认证公钥持有者身份的证书，负责确认 HTTPS 使用的 end-user 证书确实是来源于百度。这类 intermediates 证书可以有很多级，也就是说 签发人 Issuer 可能会有有很多级
* **root**：可以理解为 最高级别的签发人 Issuer，负责认证 intermediates 身份的合法性
验证的过程如下:  
1. 通过end-user证书获取上一级证书，用它的公钥对数字签名进行认证，若成功，则说明被上一级证书认证
2. 继续往上验证，直到用Root证书的公钥成功解开下级数字签名。
3. 信任链最终为Root CA，它是自签名证书。(总端会查看自己的信任列表，若在列表中，则信任)
![](/img/in-post/TLS/link2.png)

